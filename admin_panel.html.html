<!DOCTYPE html>
<html>
<head>
Â  <title>One Gate Admin Panel</title>
Â  <link href="./tailwind.min.css" rel="stylesheet">
Â  <style>
Â  Â  /* Custom styles to override or enhance Tailwind */
Â  Â  body {
Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  background-color: #f5f7fa; /* Light gray background */
Â  Â  }
Â  Â  input, select {
Â  Â  Â  padding: 8px;
Â  Â  Â  margin: 4px;
Â  Â  Â  border-radius: 0.5rem; /* rounded corners */
Â  Â  Â  border: 1px solid #d1d5db; /* Light border */
Â  Â  }
Â  Â  button {
Â  Â  Â  padding: 8px 16px; /* Slightly larger padding for buttons */
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 0.5rem; /* rounded corners */
Â  Â  Â  margin: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 500;
Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  }
Â  Â  button.edit { background-color: #ffc107; color: black; } /* Yellow */
Â  Â  button.edit:hover { background-color: #e0a800; }
Â  Â  button.update { background-color: #28a745; color: white; } /* Green */
Â  Â  button.update:hover { background-color: #218838; }
Â  Â  button.delete { background-color: #dc3545; color: white; } /* Red */
Â  Â  button.delete:hover { background-color: #c82333; }
Â  Â  button.add { background-color: #007bff; color: white; } /* Blue */
Â  Â  button.add:hover { background-color: #0069d9; }
    .google-signin-btn {
        background-color: #4285F4;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
    }
    .google-signin-btn:hover {
        background-color: #357ae8;
    }
    .google-signin-btn img {
        height: 20px;
        width: auto;
    }
Â  Â  table {
Â  Â  Â  width: 100%;
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  margin-top: 20px;
Â  Â  Â  background: #fff;
Â  Â  Â  border-radius: 0.5rem; /* rounded corners for table */
Â  Â  Â  overflow: hidden; /* Ensures rounded corners apply to content */
Â  Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
Â  Â  }
Â  Â  th, td {
Â  Â  Â  border: 1px solid #e5e7eb; /* Lighter border for cells */
Â  Â  Â  padding: 12px 16px; /* Increased padding */
Â  Â  Â  text-align: left;
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  th {
Â  Â  Â  background-color: #2c3e50; /* Dark blue-gray */
Â  Â  Â  color: white;
Â  Â  Â  font-weight: 600;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  font-size: 0.875rem; /* Smaller font size for headers */
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  th.sort-asc::after {
Â  Â  Â  content: " â–²";
Â  Â  Â  font-size: 0.7em;
Â  Â  }
Â  Â  th.sort-desc::after {
Â  Â  Â  content: " â–¼";
Â  Â  Â  font-size: 0.7em;
Â  Â  }
Â  Â  img {
Â  Â  Â  height: 40px;
Â  Â  Â  width: 40px; /* Ensure images are square */
Â  Â  Â  object-fit: cover; /* Cover the area, crop if necessary */
Â  Â  Â  border-radius: 0.25rem; /* Slightly rounded image corners */
Â  Â  }

Â  Â  .popup {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 20px;
Â  Â  Â  right: 20px;
Â  Â  Â  background: #28a745;
Â  Â  Â  color: white;
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  border-radius: 0.5rem; /* rounded corners */
Â  Â  Â  display: none;
Â  Â  Â  z-index: 1000;
Â  Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
Â  Â  Â  font-weight: 500;
Â  Â  }

Â  Â  /* Styles for the checkbox and label */
Â  Â  .checkbox-container {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px; /* Space between checkbox and label */
Â  Â  }
Â  Â  .checkbox-container input[type="checkbox"] {
Â  Â  Â  width: 1rem;
Â  Â  Â  height: 1rem;
Â  Â  Â  margin: 0; /* Remove default margin */
Â  Â  }

Â  Â  .search-container {
Â  Â  Â  margin-top: 10px;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 12px;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .search-container input, .search-container select {
Â  Â  Â  flex-grow: 1;
Â  Â  Â  max-width: 300px;
Â  Â  }

Â  Â  .filter-label {
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #374151;
Â  Â  Â  margin-right: 8px;
Â  Â  }
Â  </style>
Â  	<script src="./firebase-app-compat.js"></script>
	<script src="./firebase-firestore-compat.js"></script>
	<script src="./firebase-auth-compat.js"></script>
</head>
<body class="p-5">

<div class="popup" id="popupMsg"></div>

<div id="loginSection" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center p-5 z-50">
    <div class="bg-white p-10 rounded-lg shadow-xl text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">One Gate Admin Login</h1>
        <p class="text-gray-600 mb-6">Please sign in with your admin Google account to access the panel.</p>
        <button id="google-signin-btn" class="google-signin-btn" onclick="signInWithGoogle()">
            <img src="https://www.gstatic.com/images/branding/product/2x/google_g_lockup_48dp.png" alt="Google logo">
            Sign in with Google
        </button>
    </div>
</div>

<div id="adminPanel" class="container mx-auto p-4 bg-white shadow-lg rounded-lg" style="display:none;">
Â  <div class="flex justify-between items-center mb-6">
    <h2 class="text-4xl font-bold text-gray-800">ğŸ”¥ One Gate Admin Panel</h2>
    <div class="flex items-center gap-4">
        <span id="adminEmailDisplay" class="font-semibold text-gray-700"></span>
        <button class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" onclick="signOutUser()">Sign Out</button>
    </div>
  </div>

Â  <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
Â  Â  <h3 class="text-2xl font-semibold text-gray-700 mb-4">Add Category</h3>
Â  Â  <div class="flex flex-wrap items-center gap-4">
Â  Â  Â  <input id="catName" placeholder="Category Name" class="flex-grow">
Â  Â  Â  <input id="catImage" placeholder="Image URL" class="flex-grow">
Â  Â  Â  <input type="number" id="catPriority" placeholder="Priority" value="1" class="w-24">
Â  Â  Â  <div class="checkbox-container">
Â  Â  Â  Â  <input type="checkbox" id="catEnable" checked>
Â  Â  Â  Â  <label for="catEnable" class="text-gray-700">Enabled</label>
Â  Â  Â  </div>
Â  Â  Â  <button class="add" onclick="addCategory()">Add Category</button>
Â  Â  </div>
Â  </div>

Â  <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
Â  Â  <h3 class="text-2xl font-semibold text-gray-700 mb-4">Add Subcategory</h3>
Â  Â  <div class="flex flex-wrap items-center gap-4">
Â  Â  Â  <input id="subName" placeholder="Subcategory Name" class="flex-grow">
Â  Â  Â  <input id="subImage" placeholder="Image URL" class="flex-grow">
Â  Â  Â  <input id="subLink" placeholder="Affiliated Link URL" class="flex-grow">
Â  Â  Â  <input type="number" id="subPriority" placeholder="Priority" value="1" class="w-24">
Â  Â  Â  <div class="checkbox-container">
Â  Â  Â  Â  <input type="checkbox" id="subEnable" checked>
Â  Â  Â  Â  <label for="subEnable" class="text-gray-700">Enabled</label>
Â  Â  Â  </div>
Â  Â  Â  <select id="subCategoryId" class="flex-grow"></select>
Â  Â  Â  <button class="add" onclick="addSubcategory()">Add Subcategory</button>
Â  Â  </div>
Â  </div>

Â  Â  <h3 class="text-2xl font-semibold text-gray-700 mb-2 mt-8">ğŸ“ Categories</h3>
Â  <div class="search-container">
Â  Â  <input type="text" id="categorySearch" placeholder="Search categories by name...">
Â  </div>
Â  <div class="overflow-x-auto">
Â  Â  <table id="categoryTable">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th data-key="name">Name</th>
Â  Â  Â  Â  Â  <th data-key="image">Image URL</th>
Â  Â  Â  Â  Â  <th>Preview</th>
Â  Â  Â  Â  Â  <th data-key="priority" data-type="number">Priority</th>
Â  Â  Â  Â  Â  <th data-key="enable" data-type="boolean">Enabled</th>
Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody></tbody>
Â  Â  </table>
Â  </div>

Â  Â  <h3 class="text-2xl font-semibold text-gray-700 mb-2 mt-8">ğŸ“ Subcategories</h3>
Â  <div class="search-container">
Â  Â  <label class="filter-label" for="subcategoryCategoryFilter">Filter by Category:</label>
Â  Â  <select id="subcategoryCategoryFilter" style="max-width: 250px;">
Â  Â  Â  <option value="all" selected>All Categories</option>
Â  Â  </select>
Â  Â  <input type="text" id="subcategorySearch" placeholder="Search subcategories by name...">
Â  </div>
Â  <div class="overflow-x-auto">
Â  Â  <table id="subcategoryTable">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th data-key="name">Name</th>
Â  Â  Â  Â  Â  <th data-key="image">Image URL</th>
Â  Â  Â  Â  Â  <th>Preview</th>
Â  Â  Â  Â  Â  <th data-key="link">Link</th>
Â  Â  Â  Â  Â  <th data-key="category_id">Category ID</th>
Â  Â  Â  Â  Â  <th data-key="priority" data-type="number">Priority</th>
Â  Â  Â  Â  Â  <th data-key="enable" data-type="boolean">Enabled</th>
Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody></tbody>
Â  Â  </table>
Â  </div>
</div>

<script>
Â  // Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG IF DIFFERENT)
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBtRDC12HbjDFPKrXV0Ky2iFUmYq_lSErY",
Â  Â  authDomain: "all-in-one-app-5d42c.firebaseapp.com",
Â  Â  projectId: "all-in-one-app-5d42c",
Â  Â  storageBucket: "all-in-one-app-5d42c.firebasestorage.app",
Â  Â  messagingSenderId: "82170965701",
Â  Â  appId: "1:82170965701:android:cacaba1a057d1615048aac"
Â  };
Â  // Initialize Firebase app
Â  firebase.initializeApp(firebaseConfig);
Â  // Get Firestore and Auth instances
Â  const db = firebase.firestore();
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  // Admin email to check against
  const ADMIN_EMAIL = 'contact.appintech@gmail.com';

Â  // DOM Elements
Â  const popup = document.getElementById('popupMsg');
Â  const catSelect = document.getElementById("subCategoryId");
Â  const catTableBody = document.querySelector("#categoryTable tbody");
Â  const subTableBody = document.querySelector("#subcategoryTable tbody");
Â  const categorySearchInput = document.getElementById("categorySearch");
Â  const subcategorySearchInput = document.getElementById("subcategorySearch");
Â  const subcategoryCategoryFilter = document.getElementById("subcategoryCategoryFilter");
  const loginSection = document.getElementById('loginSection');
  const adminPanel = document.getElementById('adminPanel');
  const adminEmailDisplay = document.getElementById('adminEmailDisplay');

Â  // Data storage for filtering and sorting
Â  let categoriesData = [];
Â  let subcategoriesData = [];

Â  // Sorting state for each table
Â  let categorySortState = { key: null, direction: 1 };
Â  let subcategorySortState = { key: null, direction: 1 };

Â  // Show popup message
Â  function showPopup(msg) {
Â  Â  popup.innerText = msg;
Â  Â  popup.style.display = 'block';
Â  Â  setTimeout(() => popup.style.display = 'none', 2000);
Â  }

Â  // Confirmation dialog
Â  function showConfirmDialog(message) {
Â  Â  return new Promise(resolve => {
Â  Â  Â  const dialogId = 'confirmDialog-' + Date.now();
Â  Â  Â  const dialogHtml = `
Â  Â  Â  Â  <div id="${dialogId}" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
Â  Â  Â  Â  Â  Â  <p class="text-lg font-semibold mb-4">${message}</p>
Â  Â  Â  Â  Â  Â  <div class="flex justify-end gap-3">
Â  Â  Â  Â  Â  Â  Â  <button id="cancelBtn-${dialogId}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  <button id="confirmBtn-${dialogId}" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  Â  document.body.insertAdjacentHTML('beforeend', dialogHtml);
Â  Â  Â  const dialog = document.getElementById(dialogId);
Â  Â  Â  document.getElementById(`confirmBtn-${dialogId}`).onclick = () => { dialog.remove(); resolve(true); };
Â  Â  Â  document.getElementById(`cancelBtn-${dialogId}`).onclick = () => { dialog.remove(); resolve(false); };
Â  Â  });
Â  }

  // --- AUTHENTICATION FUNCTIONS ---
  async function signInWithGoogle() {
      try {
          await auth.signInWithPopup(provider);
          // auth.onAuthStateChanged will handle the rest
      } catch (error) {
          console.error("Google Sign-in failed:", error);
          showPopup("Sign-in failed. Please try again.");
      }
  }

  async function signOutUser() {
      try {
          await auth.signOut();
          showPopup("Signed out successfully.");
      } catch (error) {
          console.error("Sign out failed:", error);
          showPopup("Sign out failed. Please try again.");
      }
  }

  // Auth state listener to show/hide the admin panel
  auth.onAuthStateChanged(user => {
      if (user) {
          adminEmailDisplay.innerText = `Signed in as: ${user.email}`;
          if (user.email === ADMIN_EMAIL) {
              // Admin is signed in, show the panel
              loginSection.style.display = 'none';
              adminPanel.style.display = 'block';
              loadData(); // Load data only when admin is logged in
          } else {
              // Not the admin account
              loginSection.style.display = 'flex';
              adminPanel.style.display = 'none';
              showPopup("Access Denied. Please sign in with the admin account.");
              signOutUser(); // Force sign out non-admin users
          }
      } else {
          // No user is signed in, show login page
          loginSection.style.display = 'flex';
          adminPanel.style.display = 'none';
      }
  });

Â  // Add Category to Firestore
Â  async function addCategory() {
Â  Â  const name = document.getElementById("catName").value.trim();
Â  Â  const image = document.getElementById("catImage").value.trim();
Â  Â  const priority = parseInt(document.getElementById("catPriority").value, 10) || 1;
Â  Â  const enable = document.getElementById("catEnable").checked;

Â  Â  if (!name || !image) {
Â  Â  Â  showPopup("Please fill all category fields.");
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  await db.collection("categories").doc(name).set({ name, image, priority, enable });
Â  Â  Â  categoriesData.push({ name, image, priority, enable });
Â  Â  Â  refreshCategoryTable();
Â  Â  Â  refreshCategoryFilterOptions();
Â  Â  Â  showPopup("Category added successfully!");
Â  Â  Â  // Clear inputs
Â  Â  Â  document.getElementById("catName").value = "";
Â  Â  Â  document.getElementById("catImage").value = "";
Â  Â  Â  document.getElementById("catPriority").value = "1";
Â  Â  Â  document.getElementById("catEnable").checked = true;
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error adding category: ", error);
Â  Â  Â  showPopup("Error adding category.");
Â  Â  }
Â  }

Â  // Add Subcategory to Firestore
Â  async function addSubcategory() {
Â  Â  const name = document.getElementById("subName").value.trim();
Â  Â  const image = document.getElementById("subImage").value.trim();
Â  Â  const link = document.getElementById("subLink").value.trim();
Â  Â  const category_id = document.getElementById("subCategoryId").value;
Â  Â  const priority = parseInt(document.getElementById("subPriority").value, 10) || 1;
Â  Â  const enable = document.getElementById("subEnable").checked;

Â  Â  if (!name || !image || !link || !category_id) {
Â  Â  Â  showPopup("Please fill all subcategory fields.");
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  await db.collection("subcategories").doc(name).set({ name, image, link, category_id, priority, enable });
Â  Â  Â  subcategoriesData.push({ name, image, link, category_id, priority, enable });
Â  Â  Â  refreshSubcategoryTable();
Â  Â  Â  showPopup("Subcategory added successfully!");
Â  Â  Â  // Clear inputs
Â  Â  Â  document.getElementById("subName").value = "";
Â  Â  Â  document.getElementById("subImage").value = "";
Â  Â  Â  document.getElementById("subLink").value = "";
Â  Â  Â  document.getElementById("subPriority").value = "1";
Â  Â  Â  document.getElementById("subEnable").checked = true;
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error adding subcategory: ", error);
Â  Â  Â  showPopup("Error adding subcategory.");
Â  Â  }
Â  }

Â  // Build category row HTML string
Â  function buildCatRow(item) {
Â  Â  const { name, image, priority, enable } = item;
Â  Â  return `
Â  Â  Â  <td><input value="${name}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><input value="${image}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><img src="${image}" alt="${name} image" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/000000?text=No+Img';"></td>
Â  Â  Â  <td><input type="number" value="${priority}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><input type="checkbox" ${enable ? 'checked' : ''} disabled></td>
Â  Â  Â  <td class="whitespace-nowrap">
Â  Â  Â  Â  <button class="edit" onclick="enableEdit(this)">Edit</button>
Â  Â  Â  Â  <button class="update" onclick="updateCategory('${name}', this)" style="display:none;">Update</button>
Â  Â  Â  Â  <button class="delete" onclick="deleteCategory('${name}', this)">Delete</button>
Â  Â  Â  </td>`;
Â  }

Â  // Build subcategory row HTML string
Â  function buildSubRow(item) {
Â  Â  const { name, image, link, category_id, priority, enable } = item;
Â  Â  return `
Â  Â  Â  <td><input value="${name}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><input value="${image}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><img src="${image}" alt="${name} image" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/000000?text=No+Img';"></td>
Â  Â  Â  <td><input value="${link}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><input value="${category_id}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><input type="number" value="${priority}" disabled class="w-full bg-transparent border-0"></td>
Â  Â  Â  <td><input type="checkbox" ${enable ? 'checked' : ''} disabled></td>
Â  Â  Â  <td class="whitespace-nowrap">
Â  Â  Â  Â  <button class="edit" onclick="enableEdit(this)">Edit</button>
Â  Â  Â  Â  <button class="update" onclick="updateSubcategory('${name}', this)" style="display:none;">Update</button>
Â  Â  Â  Â  <button class="delete" onclick="deleteSubcategory('${name}', this)">Delete</button>
Â  Â  Â  </td>`;
Â  }

Â  // Enable editing row inputs
Â  function enableEdit(btn) {
Â  Â  const row = btn.closest("tr");
Â  Â  row.querySelectorAll("input").forEach(i => i.disabled = false);
Â  Â  row.querySelector(".update").style.display = "inline-block";
Â  Â  btn.style.display = "none";
Â  }

Â  // Update category Firestore and UI
Â  async function updateCategory(id, btn) {
Â  Â  const rowCells = btn.closest("tr").children;
Â  Â  const name = rowCells[0].querySelector("input").value.trim();
Â  Â  const image = rowCells[1].querySelector("input").value.trim();
Â  Â  const priority = parseInt(rowCells[3].querySelector("input").value, 10) || 1;
Â  Â  const enable = rowCells[4].querySelector("input").checked;

Â  Â  try {
Â  Â  Â  await db.collection("categories").doc(id).set({ name, image, priority, enable });
Â  Â  Â  // Update categoriesData
Â  Â  Â  const index = categoriesData.findIndex(c => c.name === id);
Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  categoriesData[index] = { name, image, priority, enable };
Â  Â  Â  }
Â  Â  Â  refreshCategoryTable();
Â  Â  Â  refreshCategoryFilterOptions();
Â  Â  Â  showPopup("Category updated successfully!");
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error updating category:", error);
Â  Â  Â  showPopup("Failed to update category.");
Â  Â  }
Â  }

Â  // Update subcategory Firestore and UI
Â  async function updateSubcategory(id, btn) {
Â  Â  const rowCells = btn.closest("tr").children;
Â  Â  const name = rowCells[0].querySelector("input").value.trim();
Â  Â  const image = rowCells[1].querySelector("input").value.trim();
Â  Â  const link = rowCells[3].querySelector("input").value.trim();
Â  Â  const category_id = rowCells[4].querySelector("input").value.trim();
Â  Â  const priority = parseInt(rowCells[5].querySelector("input").value, 10) || 1;
Â  Â  const enable = rowCells[6].querySelector("input").checked;

Â  Â  try {
Â  Â  Â  await db.collection("subcategories").doc(id).set({ name, image, link, category_id, priority, enable });
Â  Â  Â  // Update subcategoriesData
Â  Â  Â  const index = subcategoriesData.findIndex(s => s.name === id);
Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  subcategoriesData[index] = { name, image, link, category_id, priority, enable };
Â  Â  Â  }
Â  Â  Â  refreshSubcategoryTable();
Â  Â  Â  showPopup("Subcategory updated successfully!");
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error updating subcategory:", error);
Â  Â  Â  showPopup("Failed to update subcategory.");
Â  Â  }
Â  }

Â  // Delete category Firestore and update UI
Â  async function deleteCategory(id, btn) {
Â  Â  if (!await showConfirmDialog(`Are you sure you want to delete category '${id}'?`)) return;

Â  Â  try {
Â  Â  Â  await db.collection("categories").doc(id).delete();
Â  Â  Â  categoriesData = categoriesData.filter(c => c.name !== id);
Â  Â  Â  refreshCategoryTable();
Â  Â  Â  refreshCategoryFilterOptions();

Â  Â  Â  // Also delete subcategories with this category_id
Â  Â  Â  const toDeleteSubs = subcategoriesData.filter(s => s.category_id === id);
Â  Â  Â  for (const sub of toDeleteSubs) {
Â  Â  Â  Â  await db.collection("subcategories").doc(sub.name).delete();
Â  Â  Â  }
Â  Â  Â  subcategoriesData = subcategoriesData.filter(s => s.category_id !== id);
Â  Â  Â  refreshSubcategoryTable();

Â  Â  Â  showPopup("Category and its subcategories deleted successfully!");
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error deleting category:", error);
Â  Â  Â  showPopup("Failed to delete category.");
Â  Â  }
Â  }

Â  // Delete subcategory Firestore and update UI
Â  async function deleteSubcategory(id, btn) {
Â  Â  if (!await showConfirmDialog(`Are you sure you want to delete subcategory '${id}'?`)) return;

Â  Â  try {
Â  Â  Â  await db.collection("subcategories").doc(id).delete();
Â  Â  Â  subcategoriesData = subcategoriesData.filter(s => s.name !== id);
Â  Â  Â  refreshSubcategoryTable();
Â  Â  Â  showPopup("Subcategory deleted successfully!");
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error deleting subcategory:", error);
Â  Â  Â  showPopup("Failed to delete subcategory.");
Â  Â  }
Â  }

Â  // Refresh category dropdown filter for subcategory form and filter section
Â  function refreshCategoryFilterOptions() {
Â  Â  // Clear dropdowns
Â  Â  catSelect.innerHTML = "";
Â  Â  subcategoryCategoryFilter.innerHTML = '<option value="all" selected>All Categories</option>';

Â  Â  // Sort categories by priority ascending for dropdowns
Â  Â  const sortedCats = [...categoriesData].sort((a, b) => a.priority - b.priority);

Â  Â  for (const cat of sortedCats) {
Â  Â  Â  const option1 = document.createElement("option");
Â  Â  Â  option1.value = cat.name;
Â  Â  Â  option1.textContent = cat.name;
Â  Â  Â  catSelect.appendChild(option1);

Â  Â  Â  const option2 = document.createElement("option");
Â  Â  Â  option2.value = cat.name;
Â  Â  Â  option2.textContent = cat.name;
Â  Â  Â  subcategoryCategoryFilter.appendChild(option2);
Â  Â  }
Â  }

Â  // Refresh category table based on filter/sort/search
Â  function refreshCategoryTable() {
Â  Â  // Filter by search
Â  Â  const searchText = categorySearchInput.value.toLowerCase();

Â  Â  // Copy categoriesData
Â  Â  let filtered = categoriesData.filter(c => c.name.toLowerCase().includes(searchText));

Â  Â  // Sort if applicable
Â  Â  if (categorySortState.key) {
Â  Â  Â  const key = categorySortState.key;
Â  Â  Â  const dir = categorySortState.direction;
Â  Â  Â  filtered.sort((a, b) => {
Â  Â  Â  Â  let valA = a[key];
Â  Â  Â  Â  let valB = b[key];
Â  Â  Â  Â  // For booleans, convert true=>1 false=>0
Â  Â  Â  Â  if (typeof valA === 'boolean') valA = valA ? 1 : 0;
Â  Â  Â  Â  if (typeof valB === 'boolean') valB = valB ? 1 : 0;
Â  Â  Â  Â  // For numbers
Â  Â  Â  Â  if (typeof valA === 'number' && typeof valB === 'number') {
Â  Â  Â  Â  Â  return dir * (valA - valB);
Â  Â  Â  Â  }
Â  Â  Â  Â  // Strings compare
Â  Â  Â  Â  return dir * valA.toString().localeCompare(valB.toString());
Â  Â  Â  });
Â  Â  }

Â  Â  // Render rows
Â  Â  catTableBody.innerHTML = "";
Â  Â  for (const cat of filtered) {
Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  tr.innerHTML = buildCatRow(cat);
Â  Â  Â  catTableBody.appendChild(tr);
Â  Â  }
Â  }

Â  // Refresh subcategory table based on filter/sort/search
Â  function refreshSubcategoryTable() {
Â  Â  const searchText = subcategorySearchInput.value.toLowerCase();
Â  Â  const filterCat = subcategoryCategoryFilter.value;

Â  Â  let filtered = subcategoriesData.filter(s =>Â 
Â  Â  Â  s.name.toLowerCase().includes(searchText) &&
Â  Â  Â  (filterCat === "all" || s.category_id === filterCat)
Â  Â  );

Â  Â  if (subcategorySortState.key) {
Â  Â  Â  const key = subcategorySortState.key;
Â  Â  Â  const dir = subcategorySortState.direction;
Â  Â  Â  filtered.sort((a, b) => {
Â  Â  Â  Â  let valA = a[key];
Â  Â  Â  Â  let valB = b[key];
Â  Â  Â  Â  // Boolean conversion
Â  Â  Â  Â  if (typeof valA === 'boolean') valA = valA ? 1 : 0;
Â  Â  Â  Â  if (typeof valB === 'boolean') valB = valB ? 1 : 0;
Â  Â  Â  Â  if (typeof valA === 'number' && typeof valB === 'number') {
Â  Â  Â  Â  Â  return dir * (valA - valB);
Â  Â  Â  Â  }
Â  Â  Â  Â  return dir * valA.toString().localeCompare(valB.toString());
Â  Â  Â  });
Â  Â  }

Â  Â  subTableBody.innerHTML = "";
Â  Â  for (const sub of filtered) {
Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  tr.innerHTML = buildSubRow(sub);
Â  Â  Â  subTableBody.appendChild(tr);
Â  Â  }
Â  }

Â  // Load categories and subcategories from Firestore initially
Â  async function loadData() {
Â  Â  try {
Â  Â  Â  const catSnap = await db.collection("categories").get();
Â  Â  Â  categoriesData = catSnap.docs.map(doc => doc.data());

Â  Â  Â  const subSnap = await db.collection("subcategories").get();
Â  Â  Â  subcategoriesData = subSnap.docs.map(doc => doc.data());

Â  Â  Â  refreshCategoryFilterOptions();
Â  Â  Â  refreshCategoryTable();
Â  Â  Â  refreshSubcategoryTable();
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error loading data:", error);
Â  Â  Â  showPopup("Error loading initial data.");
Â  Â  }
Â  }

Â  // Attach event listeners for search inputs and filter select
Â  categorySearchInput.addEventListener('input', refreshCategoryTable);
Â  subcategorySearchInput.addEventListener('input', refreshSubcategoryTable);
Â  subcategoryCategoryFilter.addEventListener('change', refreshSubcategoryTable);

Â  // Sorting logic on header click for categories
Â  document.querySelectorAll("#categoryTable th[data-key]").forEach(th => {
Â  Â  th.addEventListener("click", () => {
Â  Â  Â  const key = th.getAttribute("data-key");
Â  Â  Â  const type = th.getAttribute("data-type") || "string";
Â  Â  Â  if (categorySortState.key === key) {
Â  Â  Â  Â  categorySortState.direction = -categorySortState.direction;
Â  Â  Â  } else {
Â  Â  Â  Â  categorySortState.key = key;
Â  Â  Â  Â  categorySortState.direction = 1;
Â  Â  Â  }
Â  Â  Â  updateSortIndicators("#categoryTable", categorySortState);
Â  Â  Â  refreshCategoryTable();
Â  Â  });
Â  });

Â  // Sorting logic on header click for subcategories
Â  document.querySelectorAll("#subcategoryTable th[data-key]").forEach(th => {
Â  Â  th.addEventListener("click", () => {
Â  Â  Â  const key = th.getAttribute("data-key");
Â  Â  Â  const type = th.getAttribute("data-type") || "string";
Â  Â  Â  if (subcategorySortState.key === key) {
Â  Â  Â  Â  subcategorySortState.direction = -subcategorySortState.direction;
Â  Â  Â  } else {
Â  Â  Â  Â  subcategorySortState.key = key;
Â  Â  Â  Â  subcategorySortState.direction = 1;
Â  Â  Â  }
Â  Â  Â  updateSortIndicators("#subcategoryTable", subcategorySortState);
Â  Â  Â  refreshSubcategoryTable();
Â  Â  });
Â  });

Â  // Update sort arrow indicators in table headers
Â  function updateSortIndicators(tableSelector, sortState) {
Â  Â  const ths = document.querySelectorAll(tableSelector + " th[data-key]");
Â  Â  ths.forEach(th => {
Â  Â  Â  th.classList.remove("sort-asc", "sort-desc");
Â  Â  Â  if (th.getAttribute("data-key") === sortState.key) {
Â  Â  Â  Â  th.classList.add(sortState.direction === 1 ? "sort-asc" : "sort-desc");
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Do not load data on page load, wait for admin login
Â  // loadData(); 
</script>

</body>
</html>